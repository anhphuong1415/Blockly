<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="Decription" content="BLOCKLY TRY OUT">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="webview.css">
    <link rel="stylesheet" href="toolbox_style.css">

    <script src="acorn_interpreter.js"></script>
    <script src="Libs/js/blockly/blockly_compressed.js"></script>
    <script src="Libs/js/blockly/blocks_compressed.js"></script>
    <script src="Libs/js/blockly/javascript_compressed.js"></script>
    <script src="toolbox_standard.js"></script>
    <script src="Libs/js/blockly/msg/vi.js"></script>
    <script src="CustomBlockForRange1.js"></script>
    <script src="wait_block.js"></script>
    <script src="theme.js"></script>
    <script>
        var goog = {
            provide: function () { },
            require: function () { }
        };
    </script>
    <script src="CustomField/js/field_pitch.js"></script>
    <script src="CustomField/js/field_calculate.js"></script>
    <script src="CustomField/js/field_turtle.js"></script>
    <script src="CustomField/js/field_velocity.js"></script>
    <script src="CustomField/js/field_matrix.js"></script>
    <script src="CustomField/js/field_ring.js"></script>
    <script src="CustomField/js/field_7_segments.js"></script>
    <script src="CustomField/js/field_traffic_light.js"></script>
    <script src="CustomField/js/field_keyboard.js"></script>
    <script src="GenneratorForRange.js"></script>
    <script src="custom_category_es6.js"></script>
    <script src="toolbox_label_es6.js"></script>

    <link rel="stylesheet" type="text/css" href="CustomField/css/pitch.css">
    <link rel="stylesheet" type="text/css" href="CustomField/css/turtle.css">
    <link rel="stylesheet" type="text/css" href="CustomField/css/calculate.css">
    <link rel="stylesheet" type="text/css" href="CustomField/css/velocity.css">
    <link rel="stylesheet" type="text/css" href="CustomField/css/matrixLed.css">
    <link rel="stylesheet" type="text/css" href="CustomField/css/ringled.css">
    <link rel="stylesheet" type="text/css" href="CustomField/css/field_7ledSegment.css">
    <link rel="stylesheet" type="text/css" href="CustomField/css/traffic_light.css">
    <link rel="stylesheet" type="text/css" href="CustomField/css/keyboards.css">
</head>

<body style="background-image: url(Utils/Background.png); background-size: cover;">
    <div id="bodyDiv">
        <xml id="toolbox" style="display: none">
            <category name="Di chuyển" categorystyle="list_category">
                <block type="robot_move">
                    <field name="Direction">Tiến</field>
                    <field name="Velocity">0</field>
                    <value name="Duration">
                        <block type="calculator"></block>
                    </value>
                </block>
                <block type="servo">
                    <field name="Servo_Select">Servo_1</field>
                    <field name="Angle">90</field>
                </block>
                <block type="motorselect">
                    <field name="MotorSelect">Left</field>
                    <field name="velocity">1</field>
                    <value name="Duration">
                        <block type="calculator"></block>
                    </value>
                </block>
                <block type="stop_move"></block>
            </category>
            <category name="Biểu diễn" categorystyle="list_category">
                <block type="playmusicnote">
                    <field name="Note">C</field>
                    <value name="Duration">
                        <block type="calculator"></block>
                    </value>
                </block>
                <block type="field_ledSegments">
                </block>
                <block type="relay">
                </block>
                <block type="single_led">
                </block>
                <block type="traffic_light">
                </block>
                <block type="ringled">
                    <field name="ringLedModule">Port 1</field>
                </block>
                <block type="playwithmatrix">
                    <value name="Duration">
                        <block type="calculator"></block>
                    </value>
                </block>
                <block type="rgb_led">
                    <field name="color_left">#00cccc</field>
                    <field name="color_right">#00cccc</field>
                    <value name="Duration">
                        <block type="calculator"></block>
                    </value>
                </block>
                <block type="turnoffledrbg">
                </block>
            </category>
            <category name="Cảm biến" categorystyle="list_category">
                <block type="srf05">
                    <field name="port">Port 1</field>
                </block>
                <block type="light_sensor">
                    <field name="Port">Port 1</field>
                </block>
                <block type="colorsensor">
                    <field name="Port">Port 1</field>
                </block>
                <block type="sound_sensor">
                    <field name="Port">Port 1</field>
                </block>
                <block type="path_detecter">
                    <field name="Port">Port 1</field>
                    <field name="side">bên trái</field>
                    <field name="color">màu trắng</field>
                </block>
                <block type="keyboard">
                </block>
            </category>
            <category name="Tính toán" categorystyle="list_category">
                <block type="logic_operation">
                    <field name="OP">AND</field>
                </block>
                <block type="calculator">
                </block>
                <!-- <block type="math_number">
                    <field name="NUM">1</field>
                </block> -->
                <block type="math_arithmetic">
                    <field name="OP">ADD</field>
                    <value name="A">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                    <value name="B">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                </block>
                <block type="logic_compare">
                    <field name="OP">EQ</field>
                </block>
            </category>
            <category name="Điều khiển" categorystyle="list_category">
                <block type="if_block"></block>
                <block type="stop_move"></block>
                <block type="loop">
                    <field name="NAME">0</field>
                </block>
                <block type="break_continue_loop">
                    <field name="action">nhảy vòng lặp</field>
                </block>
                <block type="if1"></block>
                <block type="wait_seconds"></block>
                <block type="while"></block>
            </category>
            <category name="Hàm" categorystyle="list_category">
                <block type="create_function">
                    <field name="Function_name">di chuyển</field>
                </block>
            </category>
            <category name="Dữ liệu" custom="VARIABLE" categorystyle="list_category"></category>
        </xml>

        <xml id="startBlocks" style="display: none">
            <block type="dummy_play_block" x="400" y="50"></block>
        </xml>
        <div id="functionButton">
            <button id="RUN" onclick="handleGenCode()"></button>
            <button id="LOAD" onclick="handleLOAD()"></button>
            <button id="SAVE" onclick="handleSave()"></button>
        </div>
        <div id="blocklyDiv">
        </div>
        <!-- <div style="margin-left: 50%; height: 600px;">
            <textarea rows="40" cols="80" id="codeSpaceText"></textarea>
        </div> -->


        <script>
            // window.currentFile = {
            //     "id": "fd127a06-8d1f-44aa-a2a9-a1fd180ae01e",
            //     "fileName": "test",
            //     "content": "<xml xmlns=\"https://developers.google.com/blockly/xml\"><block type=\"dummy_play_block\" id=\"%2QDD,(EmX`pZ4(*eIN#\" x=\"400\" y=\"50\"><next><block type=\"playmusicnote\" id=\"l`K}9aq=*walq/F%NLAH\"><field name=\"Note\">F</field><field name=\"Duration\">1</field><next><block type=\"if1\" id=\"~tizN+GQW;jqr|UIlj!f\"><value name=\"condition\"><block type=\"logic_compare\" id=\"1x^}6GwBf_o+{v@ny+@)\"><field name=\"OP\">GT</field><value name=\"A\"><block type=\"light_sensor\" id=\"Lx.9|3j0|I@8PcaQ@z:{\"><field name=\"Port\">Port 1</field></block></value><value name=\"B\"><block type=\"math_number\" id=\"B/Tp22|*2(t~6@=gIxy5\"><field name=\"NUM\">100</field></block></value></block></value><statement name=\"command\"><block type=\"playmusicnote\" id=\"VaHLm*r2J]6]/PPb3;XC\"><field name=\"Note\">C</field><field name=\"Duration\">1</field><next><block type=\"ringled\" id=\"HaZx;Jx982JqD^OT.|`x\"><field name=\"ringLedModule\">Port 1</field><field name=\"LED\" L1=\"#00cccc\" L3=\"#6633ff\" L4=\"#030303\" L5=\"#3366ff\" L2=\"#030303\" L6=\"#030303\" L7=\"#030303\" L8=\"#030303\" L9=\"#030303\" L10=\"#cc0000\" L11=\"#030303\" L12=\"#cc0000\"></field></block></next></block></statement></block></next></block></next></block><block type=\"logic_compare\" id=\"Xft4s+F/i=1C)MyAOG|@\" x=\"533\" y=\"183\"><field name=\"OP\">EQ</field></block></xml>"
            // };
            var workspacePlayground = Blockly.inject('blocklyDiv', {
                media: 'media/',
                toolbox: document.getElementById('toolbox'),
                collapse: false,
                comments: true,
                disable: true,
                maxBlocks: Infinity,
                trashcan: true,
                horizontalLayout: false,
                toolboxPosition: 'start',
                css: true,
                rtl: false,
                // scrollbars: true,
                sounds: true,
                oneBasedIndex: true,
                zoom: {
                    controls: true,
                    wheel: true,
                    startScale: 1.0,
                    maxScale: 3,
                    minScale: 0.3,
                    scaleSpeed: 1.2
                },
                theme: Blockly.Themes.Halloween
            });

            const urlParams = new URLSearchParams(window.location.search);
            for (var i = 0; i < workspacePlayground.getToolbox().getToolboxItems().length; i++) {
                var tmpCate = workspacePlayground.getToolbox().getToolboxItems()[i];
                tmpCate.setDisabled(urlParams.get(i));
            }


            function importScript() {
                var xml = Blockly.Xml.textToDom(window.currentFile.content);
                Blockly.mainWorkspace.clear();
                Blockly.Xml.domToWorkspace(xml, Blockly.mainWorkspace);
                $('#currentFileName').text('File: ' + window.currentFile.fileName)
            }
            if (window.currentFile) {
                importScript()
            } else {
                Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'),
                    workspacePlayground);
            }
            window.workspacePlayground = workspacePlayground;
            var myInterpreter = null;
            var nextStep;
            var runButton = document.getElementById('RUN');
            var x = document.getElementById("snackbar");

            Blockly.JavaScript.addReservedWords('exit');

            function initApi(interpreter, globalObject) {
                // Add an API function for the prompt() block.
                var wrapper = function (text) {
                    text = text ? text.toString() : '';
                    return interpreter.createPrimitive(prompt(text));
                };
                interpreter.setProperty(globalObject, 'prompt',
                    interpreter.createNativeFunction(wrapper));

                // Add an API for the wait block.  See wait_block.js
                initInterpreterWaitForSeconds(interpreter, globalObject);

                // Add an API function for highlighting blocks.
                var wrapper = function (id) {
                    return workspacePlayground.highlightBlock(id);
                };
                interpreter.setProperty(globalObject, 'highlightBlock',
                    interpreter.createNativeFunction(wrapper));

                var wrapper = function (payload) {
                    return sendApp(payload);
                }
                interpreter.setProperty(globalObject, 'sendApp',
                    interpreter.createNativeFunction(wrapper));

                var wrapper = function () {
                    return interpreter.createPrimitive(getValue());
                }
                interpreter.setProperty(globalObject, 'getValue',
                    interpreter.createNativeFunction(wrapper));
            }


            function getValue() {
                return window.currentValue;
            }

            Blockly.JavaScript.addReservedWords('exit');

            function sleep(ms) {
                const now = Date.now();
                const limit = now + ms;
                let execute = true;
                while (execute) {
                    if (limit < Date.now()) {
                        execute = false;
                    }
                }
                return;
            }

            document.addEventListener("message", function (event) {
                console.log("Received post message", event);

            }, false);

            function sendApp(payload) {
                console.log("SEND TO APP");
                window.ReactNativeWebView.postMessage(payload);
                return window.currentValue;
            }

            function sendCmd(action, port, m_module, duration, dirMove, additionModule, value1, value2, value3, value4, value5, value6, value7, value8, value9, value10, value11, value12) {


                if (m_module == 1) {
                    showSensor("Khoảng cách: " + getValue());
                } else if (m_module == 2) {
                    showSensor("Làn đường: " + getValue());
                } else if (m_module == 3) {
                    showSensor("Độ sáng: " + getValue());
                } else if (m_module == 4) {
                    showSensor("Màu: " + getValue());
                } else if (m_module == 10) {
                    showSensor("Âm thanh: " + getValue());
                }
                return out;
            }

            var highlightPause = false;
            var latestCode = '';

            function highlightBlock(id) {
                workspacePlayground.highlightBlock(id);
                highlightPause = true;
            }

            function resetStepUi() {
                workspacePlayground.highlightBlock(null);
                highlightPause = false;
                clearShowSensor();
            }

            function resetInterpreter() {
                myInterpreter = null;
                if (nextStep) {
                    clearTimeout(nextStep);
                    nextStep = null;
                }
            }

            var stopButton = Boolean(9 > 10);

            function stopFunction() {
                if (nextStep) {
                    clearTimeout(nextStep);
                    nextStep = null;
                }
                resetInterpreter();
                resetStepUi();
                Android.finishCmd();
            }

            function handleGenCode() {
                stopButton = !Boolean(stopButton);
                console.log(stopButton.toString());
                console.log(latestCode);
                if (Boolean(stopButton)) {
                    document.getElementById("RUN").style.background = "url(Utils/Icon/svg/Stop.svg)";
                    resetStepUi();
                    if (!myInterpreter) {
                        // First statement of this code.
                        // Clear the program output.
                        myInterpreter = new Interpreter(latestCode, initApi);
                    }
                    setTimeout(function () {
                        nextStep = function () {
                            if (myInterpreter.step()) {
                                if (Boolean(stopButton)) {
                                    setTimeout(nextStep, 10);
                                    return;
                                } else {
                                    document.getElementById("RUN").style.background = "url(Utils/Icon/svg/Start.svg)";
                                    stopFunction();
                                }
                            } else {
                                stopButton = Boolean(9 > 10);
                                resetInterpreter();
                                resetStepUi();
                                document.getElementById("RUN").style.background = "url(Utils/Icon/svg/Start.svg)";
                                // Android.finishCmd();
                            }
                        }
                        nextStep();
                        //     if (myInterpreter) {
                        //         var hasMore = myInterpreter.run();
                        //         if (hasMore) {
                        //             if (Boolean(stopButton)) {
                        //                 setTimeout(nextStep, 10);
                        //             } else {
                        //                 stopFunction();
                        //             }
                        //         } else {
                        //             stopButton = Boolean(9 > 10);
                        //             resetInterpreter();
                        //             resetStepUi();
                        //         }
                        //     }
                        // };
                        // nextStep();
                    }, 1);
                    return;
                } else {
                    document.getElementById("RUN").style.background = "url(Utils/Icon/svg/Start.svg)";
                    // Android.finishCmd();
                }
            }

            function handleTmpSave() {
                let workspace = Blockly.getMainWorkspace();
                if (typeof (Storage) !== "undefined") {
                    localStorage.removeItem("storageTmp");
                    var xml = Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace());
                    localStorage.setItem("storageTmp", Blockly.Xml.domToText(xml));
                } else { }
            }

            function handleTmpLOAD() {
                let workspace = Blockly.getMainWorkspace();
                workspace.clear();
                if (typeof (Storage) !== "undefined") {
                    // workspace.clear();
                    if (localStorage.storageTmp != null) {
                        // workspace.clear();
                        var xml = Blockly.Xml.textToDom(localStorage.getItem("storageTmp"));
                        Blockly.Xml.domToWorkspace(xml, workspace);
                    }
                }
            }

            function handleSave() {
                const data = Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace()));
                console.log(data);
                let fileName = prompt("File Name", "Untitled");
                if (fileName == null || fileName == "") {
                } else {
                    const xml = Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace()).outerHTML;
                    const payload = JSON.stringify({
                        type: 'SAVE_FILE',
                        message: {
                            id: window.currentFileID,
                            xml: data,
                            fileName
                        },
                    });
                    sendApp(payload);
                }
            }

            function handleLOAD() {
                const payload = JSON.stringify({
                    type: 'LOAD_FILE',
                });
                sendApp(payload);
            }

            function showSensor(showString) {
                // // Get the snackbar DIV
                // if (x.className != "show") {
                //     x.className = "show";
                // }
                // // Add the "show" class to DIV
                // document.getElementById("innerSnackbackText").innerHTML = showString;

                // return 0;
            }

            function clearShowSensor() {
                // if (x.className == "show") {
                //     // After 3 seconds, remove the show class from DIV
                //     setTimeout(function() {
                //         x.className = x.className.replace("show", "");
                //     }, 20);
                // }
            }

            function changeSnackBarIcon(svgAddress) {
                // Get the snackbar DIV
                var x = document.getElementById("snackbarIcon");
                x.src = svgAddress;
            }

            function handleStop() {
                clearInterval(runID);
                runID = null;
            }

            function generateCodeAndLoadIntoInterpreter() {
                // Generate JavaScript code and parse it.
                Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
                Blockly.JavaScript.addReservedWords('highlightBlock');
                latestCode = Blockly.JavaScript.workspaceToCode(workspacePlayground);
                resetStepUi();
            }

            generateCodeAndLoadIntoInterpreter();
            workspacePlayground.addChangeListener(function (event) {
                if (!event.isUiEvent) {
                    // Something changed. Parser needs to be reloaded.
                    resetInterpreter();
                    generateCodeAndLoadIntoInterpreter();
                }
            });
            // document.getElementById('genCodeCommand').addEventListener('click', handleGenCode)
        </script>
    </div>
</body>

</html>